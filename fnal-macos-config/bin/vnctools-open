#!/usr/bin/env bash

(
    set -euo pipefail
    source `which vnctools-opts` $@
    display=${display:?"Error. display not define"}
    hostname=${hostname:?"Error. hostname not define"}
    localport=${localport:=5900}
    username=${username:?"Error. username not define"}
    extra_args=${extra_args:=""}

    clean_up () {
        for job in `jobs -p`; do
            kill ${job}
        done
    }

    set -x
    trap "clean_up; exit 1" INT

    kinit -ft ~/.kerberos/${username}.keytab ${username}@FNAL.GOV && klist
    ssh  -4CKq -L ${localport}:localhost:5900  ${username}@${hostname}.fnal.gov \
        "x11vnc -display :${display} -localhost -usepw -once -noxdamage -snapfb -speeds dsl -shared -repeat $extra_args" &
    sleep 4

    case true in
        ${flag_realvnc:=})
            /Applications/VNC\ Viewer.app/Contents/MacOS/vncviewer localhost:${localport}
            ;;
        ${screenshare:=})
            open -W vnc://localhost:${localport}
            ;;
        *)
            open -W vnc://localhost:${localport}
            ;;
    esac

    clean_up
    wait
)
